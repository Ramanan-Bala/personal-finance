generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

model User {
  id    String     @id @default(cuid())
  email String     @unique
  name  String?
  passwordHash String
  
  // Relations
  refreshTokens   RefreshToken[]
  accountGroups   AccountGroup[]
  accounts        Account[]
  categories      Category[]
  transactions    Transaction[]
  lendDebts       LendDebt[]
  lendDebtPayments LendDebtPayment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model RefreshToken {
  id    String     @id @default(cuid())
  userId String
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token String @unique
  expiresAt DateTime
  revokedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("refresh_tokens")
}

// ============================================================================
// ACCOUNTS MODULE
// ============================================================================

model AccountGroup {
  id    String     @id @default(cuid())
  userId String
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  
  accounts Account[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("account_groups")
}

model Account {
  id    String     @id @default(cuid())
  userId String
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  groupId String
  group AccountGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  name           String
  openingBalance Decimal
  description    String?
  
  // Relations
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([groupId])
  @@map("accounts")
}

// ============================================================================
// CATEGORIES MODULE
// ============================================================================

enum CategoryType {
  INCOME
  EXPENSE
}

model Category {
  id    String     @id @default(cuid())
  userId String
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  type        CategoryType
  icon        String?
  description String?
  
  // Relations
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("categories")
}

// ============================================================================
// TRANSACTIONS MODULE
// ============================================================================

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

model Transaction {
  id    String     @id @default(cuid())
  userId String
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  type              TransactionType
  amount            Decimal
  transactionDate   DateTime
  notes             String?
  
  // For transfers: store the target account
  transferToAccountId String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([accountId])
  @@index([categoryId])
  @@index([transactionDate])
  @@map("transactions")
}

// ============================================================================
// LEND / DEBT MODULE
// ============================================================================

enum LendDebtType {
  LEND
  DEBT
}

enum LendDebtStatus {
  OPEN
  SETTLED
}

model LendDebt {
  id    String     @id @default(cuid())
  userId String
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          LendDebtType
  personName    String
  amount        Decimal
  dueDate       DateTime?
  status        LendDebtStatus @default(OPEN)
  notes         String?
  
  // Relations
  payments LendDebtPayment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("lend_debt")
}

model LendDebtPayment {
  id    String     @id @default(cuid())
  userId String
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  lendDebtId String
  lendDebt   LendDebt @relation(fields: [lendDebtId], references: [id], onDelete: Cascade)
  
  amount        Decimal
  paymentDate   DateTime
  notes         String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([lendDebtId])
  @@map("lend_debt_payments")
}
